<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Visitor & Staff Kiosk</title>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            position: fixed;
            width: 100%;
        }
        
        html {
            height: 100%;
            overflow: hidden;
        }
        
        .kiosk-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        
        .header h1 {
            margin: 0;
            color: #333;
            font-size: 1.8rem;
            font-weight: 300;
        }
        
        .header .date-time {
            color: #666;
            font-size: 1rem;
            margin-top: 8px;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .sign-option {
            background: white;
            border-radius: 15px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: all 0.2s ease;
            width: 90%;
            max-width: 350px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }
        
        .sign-option:active {
            transform: scale(0.98);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .sign-option .icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
        }
        
        .sign-option h2 {
            color: #333;
            font-size: 1.5rem;
            margin: 0 0 15px 0;
        }
        
        .sign-option p {
            color: #666;
            font-size: 1rem;
            margin: 0;
        }
        
        .visitor-option {
            border-left: 5px solid #4CAF50;
        }
        
        .staff-option {
            border-left: 5px solid #2196F3;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow: hidden;
        }
        
        .modal-content {
            background: white;
            margin: 0;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
            box-sizing: border-box;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
            padding: 10px;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
        }
        
        .close-btn:active {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .photo-section {
            text-align: center;
            margin: 25px 0;
        }
        
        .photo-preview {
            width: 150px;
            height: 150px;
            border: 3px dashed #ddd;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px auto;
            background: #f9f9f9;
            position: relative;
            overflow: hidden;
        }
        
        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-placeholder {
            color: #999;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 8px;
            min-width: 120px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn:active {
            background: #45a049;
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: #2196F3;
        }
        
        .btn-secondary:active {
            background: #1976D2;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:active {
            background: #d32f2f;
        }
        
        .emergency-banner {
            background: #ff4444;
            color: white;
            padding: 12px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            display: none;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .status-display {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
        }
        
        .visitor-list {
            max-height: 250px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
        }
        
        .visitor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 8px;
            border-bottom: 1px solid #eee;
        }
        
        .visitor-item:last-child {
            border-bottom: none;
        }
        
        .visitor-info {
            flex: 1;
        }
        
        .visitor-name {
            font-weight: bold;
            color: #333;
            font-size: 0.95rem;
        }
        
        .visitor-details {
            color: #666;
            font-size: 0.8rem;
        }
        
        .sign-out-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            -webkit-tap-highlight-color: transparent;
        }
        
        .sign-out-btn:active {
            background: #cc0000;
        }
        
        .emergency-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
        }
        
        .emergency-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255,68,68,0.4);
            animation: emergencyPulse 3s infinite;
            -webkit-tap-highlight-color: transparent;
        }
        
        @keyframes emergencyPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .success-message {
            background: #4CAF50;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }
        
        .error-message {
            background: #f44336;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }
        
        .config-section {
            background: #f0f8ff;
            border: 1px solid #2196F3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .config-section h4 {
            margin: 0 0 10px 0;
            color: #2196F3;
        }
        
        /* Android-specific optimizations */
        @media screen and (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header .date-time {
                font-size: 0.9rem;
            }
            
            .main-content {
                padding: 15px;
                gap: 15px;
            }
            
            .sign-option {
                padding: 30px 20px;
                min-height: 160px;
            }
            
            .sign-option .icon {
                font-size: 3rem;
                margin-bottom: 15px;
            }
            
            .sign-option h2 {
                font-size: 1.3rem;
            }
            
            .modal-content {
                padding: 15px;
            }
            
            .photo-preview {
                width: 120px;
                height: 120px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 1rem;
                margin: 5px;
            }
        }
        
        /* Landscape orientation adjustments */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .main-content {
                flex-direction: row;
                padding: 15px;
            }
            
            .sign-option {
                width: 45%;
                min-height: 140px;
                padding: 25px 15px;
            }
            
            .header {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="kiosk-container">
        <div class="emergency-banner" id="emergencyBanner">
            üö® FIRE EVACUATION IN PROGRESS - PLEASE EXIT THE BUILDING IMMEDIATELY üö®
        </div>
        
        <header class="header">
            <h1>Welcome to Our Facility</h1>
            <div class="date-time" id="dateTime"></div>
        </header>
        
        <main class="main-content">
            <div class="sign-option visitor-option" onclick="openVisitorModal()">
                <div class="icon">üë•</div>
                <h2>Visitor Sign In</h2>
                <p>New visitors and guests</p>
            </div>
            
            <div class="sign-option staff-option" onclick="openStaffModal()">
                <div class="icon">üëî</div>
                <h2>Staff Sign In/Out</h2>
                <p>Employees and team members</p>
            </div>
        </main>
        
        <div class="emergency-controls">
            <button class="emergency-btn" onclick="toggleEmergency()" title="Emergency Evacuation">
                üö®
            </button>
        </div>
    </div>
    
    <!-- Visitor Modal -->
    <div id="visitorModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('visitorModal')">&times;</button>
            <h2>Visitor Sign In</h2>
            
            <div class="success-message" id="visitorSuccess"></div>
            <div class="error-message" id="visitorError"></div>
            
            <form id="visitorForm" onsubmit="handleVisitorSignIn(event)">
                <div class="form-group">
                    <label for="visitorName">Full Name *</label>
                    <input type="text" id="visitorName" name="visitorName" required>
                </div>
                
                <div class="form-group">
                    <label for="visitorEmail">Email Address *</label>
                    <input type="email" id="visitorEmail" name="visitorEmail" required>
                </div>
                
                <div class="form-group">
                    <label for="visitorPhone">Phone Number</label>
                    <input type="tel" id="visitorPhone" name="visitorPhone">
                </div>
                
                <div class="form-group">
                    <label for="visitorCompany">Company/Organization</label>
                    <input type="text" id="visitorCompany" name="visitorCompany">
                </div>
                
                <div class="form-group">
                    <label for="hostName">Host/Person to Visit *</label>
                    <input type="text" id="hostName" name="hostName" required>
                </div>
                
                <div class="form-group">
                    <label for="visitPurpose">Purpose of Visit</label>
                    <select id="visitPurpose" name="visitPurpose">
                        <option value="">Select purpose</option>
                        <option value="meeting">Business Meeting</option>
                        <option value="interview">Interview</option>
                        <option value="delivery">Delivery</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="photo-section">
                    <label>Visitor Photo *</label>
                    <div class="photo-preview" id="photoPreview">
                        <div class="photo-placeholder">
                            üì∑<br>Tap to take photo
                        </div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" capture="user" style="display: none;" onchange="handlePhotoCapture(event)">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('photoInput').click()">
                        Take Photo
                    </button>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="agreementCheck" required style="width: auto; margin-right: 10px;">
                        I agree to follow all facility safety protocols and acknowledge that my visit is being recorded for security purposes.
                    </label>
                </div>
                
                <button type="submit" class="btn">Sign In Visitor</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('visitorModal')">Cancel</button>
            </form>
        </div>
    </div>
    
    <!-- Staff Modal -->
    <div id="staffModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('staffModal')">&times;</button>
            <h2>Staff Sign In/Out</h2>
            
            <div class="success-message" id="staffSuccess"></div>
            <div class="error-message" id="staffError"></div>
            
            <!-- M365 Configuration Status -->
            <div class="config-section">
                <h4>üîß M365 Integration Setup Required</h4>
                <p style="margin: 5px 0; font-size: 0.9rem;">To connect to your organization's directory:</p>
                <ol style="margin: 10px 0; padding-left: 20px; font-size: 0.85rem;">
                    <li>Register app in Azure AD</li>
                    <li>Get Tenant ID and Client ID</li>
                    <li>Configure API permissions</li>
                    <li>Update M365_CONFIG in code</li>
                </ol>
                <button class="btn btn-secondary" onclick="showM365Setup()" style="padding: 8px 15px; font-size: 0.9rem;">
                    View Setup Instructions
                </button>
            </div>
            
            <!-- PIN Sign In Section -->
            <div class="form-group">
                <label for="pinInput">Enter Your PIN</label>
                <input type="password" id="pinInput" placeholder="Enter 4-digit PIN" maxlength="4" oninput="handlePinInput(this.value)" style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem;">
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <span style="color: #666;">OR</span>
            </div>
            
            <!-- Staff Search Section -->
            <div class="form-group">
                <label for="staffSearch">Search Staff Directory</label>
                <input type="text" id="staffSearch" placeholder="Search by name, email, or department" oninput="searchStaff(this.value)">
                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                    <span id="m365Status">M365 Integration: Not Configured</span>
                </div>
            </div>
            
            <div id="staffResults" class="visitor-list" style="display: none;">
                <!-- Staff search results will appear here -->
            </div>
            
            <div class="status-display">
                <h3>Currently Signed In Staff</h3>
                <div id="signedInStaff" class="visitor-list">
                    <!-- Signed in staff will appear here -->
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="exportVisitorData()" style="margin: 5px;">
                    üìä Export Data
                </button>
                <button type="button" class="btn btn-secondary" onclick="showVisitorStats()" style="margin: 5px;">
                    üìà View Stats
                </button>
            </div>
            
            <button type="button" class="btn btn-secondary" onclick="closeModal('staffModal')">Close</button>
        </div>
    </div>
    
    <!-- PIN Registration Modal -->
    <div id="pinRegistrationModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('pinRegistrationModal')">&times;</button>
            <h2>Register Your PIN</h2>
            
            <div class="success-message" id="pinSuccess"></div>
            <div class="error-message" id="pinError"></div>
            
            <div id="selectedUserInfo" class="status-display" style="margin: 20px 0;">
                <!-- Selected user info will appear here -->
            </div>
            
            <form id="pinRegistrationForm" onsubmit="handlePinRegistration(event)">
                <div class="form-group">
                    <label for="newPin">Create 4-Digit PIN *</label>
                    <input type="password" id="newPin" name="newPin" placeholder="Enter 4-digit PIN" maxlength="4" required style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem;" oninput="validatePinInput(this)">
                </div>
                
                <div class="form-group">
                    <label for="confirmPin">Confirm PIN *</label>
                    <input type="password" id="confirmPin" name="confirmPin" placeholder="Re-enter PIN" maxlength="4" required style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem;" oninput="validatePinInput(this)">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="pinAgreement" required style="width: auto; margin-right: 10px;">
                        I understand this PIN will be used for secure access to the kiosk system and I am responsible for keeping it confidential.
                    </label>
                </div>
                
                <button type="submit" class="btn">Register PIN</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('pinRegistrationModal')">Cancel</button>
            </form>
        </div>
    </div>
    
    <!-- M365 Setup Instructions Modal -->
    <div id="m365SetupModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('m365SetupModal')">&times;</button>
            <h2>üîß Complete Azure AD Setup Guide</h2>
            
            <div class="config-section">
                <h4>üìã Prerequisites</h4>
                <ul style="padding-left: 20px; font-size: 0.9rem;">
                    <li>‚úÖ <strong>Global Administrator</strong> or <strong>Application Administrator</strong> role in Azure AD</li>
                    <li>‚úÖ Access to <strong>Azure Portal</strong> (portal.azure.com)</li>
                    <li>‚úÖ Your organization's <strong>M365 tenant</strong></li>
                </ul>
            </div>
            
            <div class="config-section">
                <h4>üöÄ Step 1: Access Azure Portal</h4>
                <ol style="padding-left: 20px; font-size: 0.9rem;">
                    <li>Open browser and go to: <strong>https://portal.azure.com</strong></li>
                    <li>Sign in with your <strong>admin account</strong></li>
                    <li>In the search bar, type: <strong>"Azure Active Directory"</strong></li>
                    <li>Click on <strong>"Azure Active Directory"</strong> from results</li>
                </ol>
            </div>
            
            <div class="config-section">
                <h4>üì± Step 2: Create App Registration</h4>
                <ol style="padding-left: 20px; font-size: 0.9rem;">
                    <li>In Azure AD, click <strong>"App registrations"</strong> in left menu</li>
                    <li>Click <strong>"+ New registration"</strong> button (top of page)</li>
                    <li><strong>Name:</strong> Type "Visitor Kiosk System"</li>
                    <li><strong>Supported account types:</strong> Select <strong>"Accounts in this organizational directory only"</strong></li>
                    <li><strong>Redirect URI:</strong> 
                        <ul style="margin: 5px 0;">
                            <li>Select <strong>"Single-page application (SPA)"</strong> from dropdown</li>
                            <li>Enter: <strong>https://yourdomain.com/kiosk</strong> (or your tablet URL)</li>
                        </ul>
                    </li>
                    <li>Click <strong>"Register"</strong> button</li>
                </ol>
            </div>
            
            <div class="config-section">
                <h4>üîë Step 3: Copy Important IDs</h4>
                <p style="font-size: 0.9rem; margin-bottom: 10px;">After registration, you'll see the app overview page. <strong>COPY THESE VALUES:</strong></p>
                <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <p style="margin: 5px 0; font-size: 0.85rem;"><strong>üìã Application (client) ID:</strong> <span style="font-family: monospace; background: #f8f9fa; padding: 2px 5px;">xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</span></p>
                    <p style="margin: 5px 0; font-size: 0.85rem;"><strong>üìã Directory (tenant) ID:</strong> <span style="font-family: monospace; background: #f8f9fa; padding: 2px 5px;">xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</span></p>
                </div>
                <p style="font-size: 0.85rem; color: #666;">üí° <strong>Tip:</strong> Keep these IDs safe - you'll need them in Step 6!</p>
            </div>
            
            <div class="config-section">
                <h4>üîê Step 4: Configure API Permissions</h4>
                <ol style="padding-left: 20px; font-size: 0.9rem;">
                    <li>In your app, click <strong>"API permissions"</strong> in left menu</li>
                    <li>Click <strong>"+ Add a permission"</strong></li>
                    <li>Select <strong>"Microsoft Graph"</strong></li>
                    <li>Choose <strong>"Delegated permissions"</strong></li>
                    <li>Search and select these permissions:
                        <ul style="margin: 5px 0; padding-left: 15px;">
                            <li>‚úÖ <strong>User.Read.All</strong> (Read all users' full profiles)</li>
                            <li>‚úÖ <strong>Directory.Read.All</strong> (Read directory data)</li>
                        </ul>
                    </li>
                    <li>Click <strong>"Add permissions"</strong></li>
                    <li><strong>IMPORTANT:</strong> Click <strong>"Grant admin consent for [Your Organization]"</strong></li>
                    <li>Click <strong>"Yes"</strong> to confirm</li>
                </ol>
            </div>
            
            <div class="config-section">
                <h4>üåê Step 5: Configure Authentication</h4>
                <ol style="padding-left: 20px; font-size: 0.9rem;">
                    <li>Click <strong>"Authentication"</strong> in left menu</li>
                    <li>Under <strong>"Implicit grant and hybrid flows"</strong>:
                        <ul style="margin: 5px 0; padding-left: 15px;">
                            <li>‚úÖ Check <strong>"Access tokens"</strong></li>
                            <li>‚úÖ Check <strong>"ID tokens"</strong></li>
                        </ul>
                    </li>
                    <li>Click <strong>"Save"</strong></li>
                </ol>
            </div>
            
            <div class="config-section">
                <h4>üíª Step 6: Update Kiosk Configuration</h4>
                <p style="font-size: 0.9rem;">In your kiosk code, find the M365_CONFIG section and update:</p>
                <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; font-size: 0.8rem; overflow-x: auto; border-left: 4px solid #4CAF50;">
const M365_CONFIG = {
    tenantId: 'YOUR-TENANT-ID-FROM-STEP-3',
    clientId: 'YOUR-CLIENT-ID-FROM-STEP-3', 
    apiEndpoint: 'https://graph.microsoft.com/v1.0/users',
    enabled: true  // ‚Üê Change this to true!
};</pre>
                <p style="font-size: 0.85rem; color: #666; margin-top: 10px;">üí° Replace the placeholder values with your actual IDs from Step 3</p>
            </div>
            
            <div class="config-section">
                <h4>‚úÖ Step 7: Test the Integration</h4>
                <ol style="padding-left: 20px; font-size: 0.9rem;">
                    <li>Save and reload your kiosk app</li>
                    <li>Open <strong>"Staff Sign In/Out"</strong></li>
                    <li>Try searching for a user name</li>
                    <li>You should see <strong>"M365 Integration: Connected"</strong> in green</li>
                    <li>Staff can now search and register PINs!</li>
                </ol>
            </div>
            
            <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 15px; margin: 15px 0;">
                <h4 style="color: #155724; margin: 0 0 10px 0;">üéâ Setup Complete!</h4>
                <p style="color: #155724; margin: 0; font-size: 0.9rem;">Your kiosk is now connected to M365! Staff can search the directory and register PINs for quick access.</p>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button type="button" class="btn" onclick="testM365Connection()" style="margin: 5px;">
                    üß™ Test Connection
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('m365SetupModal')" style="margin: 5px;">
                    Close Guide
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state management
        let visitors = JSON.parse(localStorage.getItem('visitors') || '[]');
        let staff = JSON.parse(localStorage.getItem('staff') || '[]');
        let signedInStaff = JSON.parse(localStorage.getItem('signedInStaff') || '[]');
        let emergencyMode = false;
        
        // M365 Configuration - Replace with your tenant details
        const M365_CONFIG = {
            tenantId: '', // Your M365 Tenant ID (e.g., 'contoso.onmicrosoft.com')
            clientId: '', // Your registered app client ID
            apiEndpoint: 'https://graph.microsoft.com/v1.0/users', // Microsoft Graph API endpoint
            enabled: false // Set to true when M365 is configured
        };
        
        // Local staff directory (populated from M365 or manual entry)
        let staffDirectory = JSON.parse(localStorage.getItem('staffDirectory') || '[]');
        
        // Store registered PINs (in production, this would be in secure backend)
        let registeredPins = JSON.parse(localStorage.getItem('registeredPins') || '{}');
        
        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Prevent context menu on long press
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        
        // Initialize the app
        function init() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            cleanupOldRecords();
            updateSignedInStaffDisplay();
            updateM365Status();
            
            // Auto-cleanup every hour
            setInterval(cleanupOldRecords, 3600000);
            
            // Handle orientation changes
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    window.scrollTo(0, 0);
                }, 100);
            });
        }
        
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('dateTime').textContent = now.toLocaleDateString('en-US', options);
        }
        
        function updateM365Status() {
            const statusElement = document.getElementById('m365Status');
            if (M365_CONFIG.enabled && M365_CONFIG.tenantId && M365_CONFIG.clientId) {
                statusElement.textContent = `M365 Integration: Connected (${M365_CONFIG.tenantId})`;
                statusElement.style.color = '#4CAF50';
            } else {
                statusElement.textContent = 'M365 Integration: Not Configured';
                statusElement.style.color = '#ff4444';
            }
        }
        
        function showM365Setup() {
            document.getElementById('m365SetupModal').style.display = 'block';
        }
        
        function openVisitorModal() {
            document.getElementById('visitorModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            clearMessages();
        }
        
        function openStaffModal() {
            document.getElementById('staffModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            updateSignedInStaffDisplay();
            updateM365Status();
            clearMessages();
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'hidden';
            if (modalId === 'visitorModal') {
                document.getElementById('visitorForm').reset();
                resetPhotoPreview();
            }
            if (modalId === 'staffModal') {
                document.getElementById('staffSearch').value = '';
                document.getElementById('staffResults').style.display = 'none';
                document.getElementById('pinInput').value = '';
            }
            if (modalId === 'pinRegistrationModal') {
                document.getElementById('pinRegistrationForm').reset();
            }
        }
        
        function openPinRegistration(staffId) {
            const staff = staffDirectory.find(s => s.id === staffId);
            if (!staff) return;
            
            // Show selected user info
            document.getElementById('selectedUserInfo').innerHTML = `
                <h4>Setting PIN for:</h4>
                <div class="visitor-name">${staff.name || staff.displayName}</div>
                <div class="visitor-details">${staff.jobTitle || 'N/A'} - ${staff.department || 'N/A'}</div>
                <div class="visitor-details" style="font-size: 0.9rem; color: #666;">${staff.email || staff.mail || staff.userPrincipalName}</div>
            `;
            
            // Store selected staff ID for registration
            document.getElementById('pinRegistrationForm').dataset.staffId = staffId;
            
            // Close staff modal and open PIN registration
            closeModal('staffModal');
            document.getElementById('pinRegistrationModal').style.display = 'block';
            clearMessages();
        }
        
        function validatePinInput(input) {
            // Only allow numbers
            input.value = input.value.replace(/[^0-9]/g, '');
        }
        
        function handlePinRegistration(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const staffId = event.target.dataset.staffId;
            const newPin = formData.get('newPin');
            const confirmPin = formData.get('confirmPin');
            
            // Validation
            if (newPin.length !== 4) {
                showMessage('pinError', 'PIN must be exactly 4 digits.', true);
                return;
            }
            
            if (newPin !== confirmPin) {
                showMessage('pinError', 'PINs do not match. Please try again.', true);
                return;
            }
            
            // Check if PIN is already in use
            const existingUser = Object.keys(registeredPins).find(id => registeredPins[id] === newPin);
            if (existingUser && existingUser !== staffId) {
                showMessage('pinError', 'This PIN is already in use. Please choose a different PIN.', true);
                return;
            }
            
            // Register the PIN
            registeredPins[staffId] = newPin;
            localStorage.setItem('registeredPins', JSON.stringify(registeredPins));
            
            const staff = staffDirectory.find(s => s.id === staffId);
            showMessage('pinSuccess', `PIN successfully registered for ${staff.name || staff.displayName}! You can now use your PIN for quick sign-in.`);
            
            // Simulate M365 integration
            console.log('M365 Integration: PIN registered for user', { staffId, staffName: staff.name || staff.displayName });
            
            // Close modal after 3 seconds
            setTimeout(() => {
                closeModal('pinRegistrationModal');
                openStaffModal(); // Return to staff modal
            }, 3000);
        }
        
        function clearMessages() {
            document.getElementById('visitorSuccess').style.display = 'none';
            document.getElementById('visitorError').style.display = 'none';
            document.getElementById('staffSuccess').style.display = 'none';
            document.getElementById('staffError').style.display = 'none';
            document.getElementById('pinSuccess').style.display = 'none';
            document.getElementById('pinError').style.display = 'none';
        }
        
        function showMessage(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
        
        function handleVisitorSignIn(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const photoInput = document.getElementById('photoInput');
            
            if (!photoInput.files[0]) {
                showMessage('visitorError', 'Please take a photo before signing in.', true);
                return;
            }
            
            const visitor = {
                id: 'VIS' + Date.now(),
                name: formData.get('visitorName'),
                email: formData.get('visitorEmail'),
                phone: formData.get('visitorPhone'),
                company: formData.get('visitorCompany'),
                host: formData.get('hostName'),
                purpose: formData.get('visitPurpose'),
                signInTime: new Date().toISOString(),
                photo: document.querySelector('#photoPreview img')?.src || null,
                signedOut: false,
                deviceId: getDeviceId()
            };
            
            visitors.push(visitor);
            localStorage.setItem('visitors', JSON.stringify(visitors));
            
            // Simulate M365 integration notification
            console.log('M365 Integration: Visitor signed in', visitor);
            
            showMessage('visitorSuccess', `Welcome ${visitor.name}! You have been successfully signed in. Please wait for your host.`);
            
            // Reset form after 3 seconds
            setTimeout(() => {
                closeModal('visitorModal');
            }, 3000);
        }
        
        function handlePhotoCapture(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('photoPreview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Visitor photo">`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function resetPhotoPreview() {
            document.getElementById('photoPreview').innerHTML = `
                <div class="photo-placeholder">
                    üì∑<br>Tap to take photo
                </div>
            `;
        }
        
        function handlePinInput(pin) {
            // Only process when PIN is 4 digits
            if (pin.length === 4) {
                const staff = findStaffByPin(pin);
                if (staff) {
                    // Auto sign in/out with PIN
                    toggleStaffSignIn(staff.id, staff.name || staff.displayName, staff.department || 'N/A');
                    document.getElementById('pinInput').value = '';
                } else {
                    showMessage('staffError', 'Invalid PIN. Please try again or search for your name below.', true);
                    document.getElementById('pinInput').value = '';
                }
            }
        }
        
        function findStaffByPin(pin) {
            const staffId = Object.keys(registeredPins).find(id => registeredPins[id] === pin);
            return staffId ? staffDirectory.find(staff => staff.id === staffId) : null;
        }
        
        async function searchStaff(query) {
            const resultsDiv = document.getElementById('staffResults');
            
            if (query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            // Show loading state
            resultsDiv.innerHTML = '<div class="visitor-item">Searching directory...</div>';
            resultsDiv.style.display = 'block';
            
            let searchResults = [];
            
            if (M365_CONFIG.enabled && M365_CONFIG.tenantId && M365_CONFIG.clientId) {
                // Real M365 Search via Microsoft Graph API
                try {
                    searchResults = await searchM365Users(query);
                } catch (error) {
                    console.error('M365 Search Error:', error);
                    resultsDiv.innerHTML = '<div class="visitor-item">M365 connection error. Please check configuration.</div>';
                    return;
                }
            } else {
                // Local directory search (fallback)
                searchResults = staffDirectory.filter(staff => 
                    (staff.name && staff.name.toLowerCase().includes(query.toLowerCase())) ||
                    (staff.displayName && staff.displayName.toLowerCase().includes(query.toLowerCase())) ||
                    (staff.id && staff.id.toLowerCase().includes(query.toLowerCase())) ||
                    (staff.department && staff.department.toLowerCase().includes(query.toLowerCase())) ||
                    (staff.email && staff.email.toLowerCase().includes(query.toLowerCase())) ||
                    (staff.mail && staff.mail.toLowerCase().includes(query.toLowerCase())) ||
                    (staff.jobTitle && staff.jobTitle.toLowerCase().includes(query.toLowerCase()))
                );
            }
            
            if (searchResults.length > 0) {
                resultsDiv.innerHTML = searchResults.map(staff => `
                    <div class="visitor-item">
                        <div class="visitor-info">
                            <div class="visitor-name">${staff.name || staff.displayName}</div>
                            <div class="visitor-details">${staff.jobTitle || 'N/A'} - ${staff.department || 'N/A'}</div>
                            <div class="visitor-details" style="font-size: 0.75rem; color: #888;">${staff.email || staff.mail || staff.userPrincipalName}</div>
                        </div>
                        <div style="display: flex; gap: 5px; flex-direction: column;">
                            <button class="btn" onclick="toggleStaffSignIn('${staff.id}', '${staff.name || staff.displayName}', '${staff.department || 'N/A'}')" style="min-width: 80px; padding: 6px 10px; font-size: 0.85rem;">
                                ${isStaffSignedIn(staff.id) ? 'Sign Out' : 'Sign In'}
                            </button>
                            ${!registeredPins[staff.id] ? `
                                <button class="btn btn-secondary" onclick="openPinRegistration('${staff.id}')" style="min-width: 80px; padding: 6px 10px; font-size: 0.8rem;">
                                    Set PIN
                                </button>
                            ` : `
                                <span style="font-size: 0.7rem; color: #4CAF50; text-align: center;">‚úì PIN Set</span>
                            `}
                        </div>
                    </div>
                `).join('');
            } else {
                if (M365_CONFIG.enabled) {
                    resultsDiv.innerHTML = '<div class="visitor-item">No users found in M365 directory</div>';
                } else {
                    resultsDiv.innerHTML = `
                        <div class="visitor-item">
                            <div class="visitor-info">
                                <div class="visitor-name">M365 Not Connected</div>
                                <div class="visitor-details">Configure M365 integration to search your organization directory</div>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // Microsoft Graph API integration
        async function searchM365Users(query) {
            // This would require proper authentication in production
            // For now, return empty array as M365 is not configured
            console.log('M365 Search would query:', `${M365_CONFIG.apiEndpoint}?$search="displayName:${query}"&$select=id,displayName,mail,jobTitle,department,userPrincipalName`);
            
            // In production, this would be:
            // const response = await fetch(`${M365_CONFIG.apiEndpoint}?$search="displayName:${query}"&$select=id,displayName,mail,jobTitle,department,userPrincipalName`, {
            //     headers: {
            //         'Authorization': `Bearer ${accessToken}`,
            //         'Content-Type': 'application/json'
            //     }
            // });
            // return await response.json();
            
            return [];
        }
        
        function isStaffSignedIn(staffId) {
            return signedInStaff.some(staff => staff.id === staffId);
        }
        
        function toggleStaffSignIn(staffId, staffName, department) {
            const existingIndex = signedInStaff.findIndex(staff => staff.id === staffId);
            
            if (existingIndex >= 0) {
                // Sign out
                signedInStaff.splice(existingIndex, 1);
                showMessage('staffSuccess', `${staffName} has been signed out.`);
            } else {
                // Sign in
                signedInStaff.push({
                    id: staffId,
                    name: staffName,
                    department: department,
                    signInTime: new Date().toISOString(),
                    deviceId: getDeviceId()
                });
                showMessage('staffSuccess', `${staffName} has been signed in.`);
            }
            
            localStorage.setItem('signedInStaff', JSON.stringify(signedInStaff));
            updateSignedInStaffDisplay();
            
            // Refresh search results
            const searchValue = document.getElementById('staffSearch').value;
            if (searchValue.length >= 2) {
                searchStaff(searchValue);
            }
            
            // Simulate M365 integration
            console.log('M365 Integration: Staff status updated', { staffId, staffName, signedIn: existingIndex < 0 });
        }
        
        function updateSignedInStaffDisplay() {
            const container = document.getElementById('signedInStaff');
            
            if (signedInStaff.length === 0) {
                container.innerHTML = '<div class="visitor-item">No staff currently signed in</div>';
                return;
            }
            
            container.innerHTML = signedInStaff.map(staff => `
                <div class="visitor-item">
                    <div class="visitor-info">
                        <div class="visitor-name">${staff.name}</div>
                        <div class="visitor-details">${staff.department} - ${new Date(staff.signInTime).toLocaleTimeString()}</div>
                    </div>
                    <button class="sign-out-btn" onclick="toggleStaffSignIn('${staff.id}', '${staff.name}', '${staff.department}')">
                        Sign Out
                    </button>
                </div>
            `).join('');
        }
        
        function toggleEmergency() {
            emergencyMode = !emergencyMode;
            const banner = document.getElementById('emergencyBanner');
            
            if (emergencyMode) {
                banner.style.display = 'block';
                // In real implementation, this would trigger M365 notifications
                console.log('EMERGENCY: Fire evacuation initiated - notifying all staff via M365');
                
                // Auto-sign out all visitors and staff for safety tracking
                visitors.forEach(visitor => {
                    if (!visitor.signedOut) {
                        visitor.signedOut = true;
                        visitor.signOutTime = new Date().toISOString();
                        visitor.signOutReason = 'Emergency Evacuation';
                    }
                });
                
                signedInStaff.forEach(staff => {
                    staff.emergencySignOut = new Date().toISOString();
                });
                
                localStorage.setItem('visitors', JSON.stringify(visitors));
                localStorage.setItem('signedInStaff', JSON.stringify(signedInStaff));
                
            } else {
                banner.style.display = 'none';
                console.log('Emergency mode deactivated');
            }
        }
        
        function cleanupOldRecords() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            // Keep visitor records for exactly 30 days for compliance
            const oldVisitorCount = visitors.length;
            visitors = visitors.filter(visitor => 
                new Date(visitor.signInTime) > thirtyDaysAgo
            );
            
            if (visitors.length !== oldVisitorCount) {
                localStorage.setItem('visitors', JSON.stringify(visitors));
                console.log(`Archived ${oldVisitorCount - visitors.length} visitor records older than 30 days`);
                
                // Log retention compliance
                console.log(`Visitor data retention: ${visitors.length} records maintained within 30-day window`);
            }
            
            // Clean up old staff sign-in records (keep only current session)
            const oldStaffCount = signedInStaff.length;
            signedInStaff = signedInStaff.filter(staff => 
                new Date(staff.signInTime) > thirtyDaysAgo
            );
            
            if (signedInStaff.length !== oldStaffCount) {
                localStorage.setItem('signedInStaff', JSON.stringify(signedInStaff));
                updateSignedInStaffDisplay();
            }
        }
        
        // Export visitor data for compliance/backup
        function exportVisitorData() {
            const dataToExport = {
                visitors: visitors,
                exportDate: new Date().toISOString(),
                totalRecords: visitors.length,
                retentionPeriod: '30 days',
                deviceId: getDeviceId()
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `visitor-records-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showMessage('staffSuccess', `Exported ${visitors.length} visitor records for compliance backup.`);
        }
        
        // Get visitor statistics
        function getVisitorStats() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const thisWeek = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
            const thisMonth = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            return {
                total: visitors.length,
                today: visitors.filter(v => new Date(v.signInTime) >= today).length,
                thisWeek: visitors.filter(v => new Date(v.signInTime) >= thisWeek).length,
                thisMonth: visitors.filter(v => new Date(v.signInTime) >= thisMonth).length,
                currentlySignedIn: visitors.filter(v => !v.signedOut).length
            };
        }
        
        function showVisitorStats() {
            const stats = getVisitorStats();
            const message = `üìä Visitor Statistics:\n\n` +
                `Today: ${stats.today} visitors\n` +
                `This Week: ${stats.thisWeek} visitors\n` +
                `This Month: ${stats.thisMonth} visitors\n` +
                `Total Records: ${stats.total} visitors\n` +
                `Currently Signed In: ${stats.currentlySignedIn} visitors`;
            
            showMessage('staffSuccess', message.replace(/\n/g, ' | '));
        }
        
        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'KIOSK-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }
        
        // Test M365 connection
        function testM365Connection() {
            if (M365_CONFIG.enabled && M365_CONFIG.tenantId && M365_CONFIG.clientId) {
                showMessage('staffSuccess', '‚úÖ M365 Configuration looks good! Try searching for a staff member to test the connection.');
            } else {
                showMessage('staffError', '‚ùå M365 not configured. Please complete Step 6 in the setup guide.', true);
            }
        }
        
        // Handle modal clicks outside content
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'hidden';
                }
            });
        }
        
        // Initialize app when page loads
        init();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'993b9c20e13563d2',t:'MTc2MTMzMTMwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
